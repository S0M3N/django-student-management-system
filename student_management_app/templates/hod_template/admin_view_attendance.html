{% extends 'hod_template/base_template.html' %}

{% block page_title %}
    View Attendance
{% endblock page_title %}

{% block main_content %}

{% load static %}

<section class="py-8">
    <div class="container mx-auto">

        <div class="bg-white rounded-lg shadow-md">
            <div class="px-5 py-3 border-b">
                <h3 class="text-lg font-semibold text-gray-700">View Attendance</h3>
            </div>

            {% comment %} Display Messages {% endcomment %}
            {% if messages %}
            <div class="px-5 py-3">
                {% for message in messages %}
                    <div class="alert alert-dismissible fade show {{ message.tags }} mb-3" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="p-5">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Subject</label>
                    <select class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" name="subject" id="subject">
                        {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Session Year</label>
                    <select class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" name="session_year_id" id="session_year_id">
                        {% for session_year in session_years %}
                            <option value="{{ session_year.id }}">{{ session_year.session_start_year }} to {{ session_year.session_end_year }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="px-5 py-3 border-t border-gray-200">
                <button type="button" class="btn btn-primary px-4 py-2 text-white bg-blue-600 rounded hover:bg-blue-700" id="fetch_attendance">Fetch Attendance Date</button>
            </div>

            <div class="px-5 py-3 border-t border-gray-200" id="attendance_block" style="display:none;">
                <label class="block text-sm font-medium text-gray-700">Attendance Date</label>
                <select class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" name="attendance_date" id="attendance_date">
                </select>
            </div>

            <div class="p-5">
                <div class="alert alert-danger hidden" id="error_attendance"></div>
                <div class="alert alert-success hidden" id="success_attendance"></div>
            </div>

            <div class="px-5 py-3 border-t border-gray-200" id="fetch_student_block" style="display:none;">
                <button type="button" class="btn btn-primary px-4 py-2 text-white bg-blue-600 rounded hover:bg-blue-700" id="fetch_student">Fetch Student Data</button>
            </div>

            <div class="px-5 py-3 border-t border-gray-200" id="student_data">
                <!-- Student data will be populated here -->
            </div>
        </div>
    </div>
</section>

{% endblock main_content %}

{% block custom_js %}

<script>
    $(document).ready(function(){
        
        // Fetching Attendance Date
        $("#fetch_attendance").click(function(){
            var subject = $("#subject").val();
            var session_year_id = $("#session_year_id").val();

            $.ajax({
                url: '{% url "admin_get_attendance_dates" %}',
                type: 'POST',
                data: {subject: subject, session_year_id: session_year_id},
            })
            .done(function(response) {
                var json_data = JSON.parse(response);
                if (json_data.length > 0) {
                    var html_data = "";
                    for (key in json_data) {
                        html_data += "<option value='" + json_data[key]["id"] + "'>" + json_data[key]["attendance_date"] + "</option>";
                    }
                    $("#error_attendance").html("").hide();
                    $("#attendance_block").show();
                    $("#fetch_student_block").show();
                    $("#attendance_date").html(html_data);
                } else {
                    $("#error_attendance").html("No Attendance Data Found.").show();
                    $("#attendance_block").hide();
                    $("#fetch_student_block").hide();
                    $("#attendance_date").html(""); // Empty the Date Dropdown also
                }
            })
            .fail(function() {
                alert("Error in getting Attendance Dates.");
                $("#error_attendance").html("").hide();
                $("#fetch_student_block").hide();
                $("#attendance_block").hide();
            });
        });

        // Fetching Student Data
        $("#fetch_student").click(function() {
            var attendance_date = $("#attendance_date").val();

            $.ajax({
                url: '{% url "admin_get_attendance_student" %}',
                type: 'POST',
                data: {attendance_date: attendance_date},
            })
            .done(function(response) {
                var json_data = JSON.parse(response);
                var div_data = "<div class='mb-4'><label class='block text-sm font-medium text-gray-700'>Student Attendance:</label></div>";
                div_data += "<div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4'>";

                for (key in json_data) {
                    div_data += "<div class='bg-gray-100 p-3 rounded-lg'>";
                    div_data += "<label class='font-medium'>" + json_data[key]['name'] + " </label> ";
                    if (json_data[key]['status']) {
                        div_data += "<b class='text-green-600'>[ Present ]</b>";
                    } else {
                        div_data += "<b class='text-red-600'>[ Absent ]</b>";
                    }
                    div_data += "</div>";
                }
                div_data += "</div>";
                
                $("#student_data").html(div_data);
            })
            .fail(function() {
                alert("Error in Fetching Students.");
            });
        });
    });
</script>

{% endblock custom_js %}
