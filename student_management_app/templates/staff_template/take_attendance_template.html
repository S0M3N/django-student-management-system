{% extends 'staff_template/base_template.html' %}

{% block page_title %}
Take Attendance
{% endblock page_title %}

{% block main_content %}

{% load static %}

<section class="py-6">
    <div class="container mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">Take Attendance</h3>

            {% comment %} Display Messages {% endcomment %}
            {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                <div class="bg-{{ message.tags }}-200 text-{{ message.tags }}-800 border border-{{ message.tags }}-300 rounded-lg p-4 mb-2"
                    role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="mb-4">
                <label for="subject" class="block text-sm font-medium mb-1">Subject</label>
                <select class="form-select block w-full mt-1" name="subject" id="subject">
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-4">
                <label for="session_year" class="block text-sm font-medium mb-1">Session Year</label>
                <select class="form-select block w-full mt-1" name="session_year" id="session_year">
                    {% for session_year in session_years %}
                    <option value="{{ session_year.id }}">{{ session_year.session_start_year }} to {{ session_year.session_end_year }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="flex justify-end">
                <button type="button" class="btn bg-blue-400 text-white rounded-lg px-4 py-2" id="fetch_student">Fetch Students</button>
            </div>

            {% comment %} Displaying Students Here {% endcomment %}
            <div class="mt-4" id="student_data"></div>
        </div>
    </div>
</section>

{% endblock main_content %}

{% block custom_js %}
<script>
    $(document).ready(function () {
        $("#fetch_student").click(function () {
            const subject = $("#subject").val();
            const session_year = $("#session_year").val();

            $.ajax({
                url: '{% url 'get_students' %}',
                type: 'POST',
                data: { subject: subject, session_year: session_year },
                success: function (response) {
                    const json_data = JSON.parse(response);
                    console.log(json_data);
                    renderStudentAttendance(json_data);
                },
                error: function () {
                    alert("Error in Fetching Students.");
                }
            });
        });

        function renderStudentAttendance(students) {
            let div_data = `
                <div class='mb-4'>
                    <label for='attendance_date' class='block text-sm font-medium mb-1'>Attendance Date:</label>
                    <input type='date' name='attendance_date' id='attendance_date' class='form-input block w-full mt-1' required />
                </div>
                <div class='mb-4'>
                    <div class='grid grid-cols-2 md:grid-cols-4 gap-4'>`;

            students.forEach(student => {
                div_data += `
        <div class="flex items-center mb-2">
            <input type="checkbox" name="student_data[]" value="${student.id}" id="student_${student.id}" class="form-check-input h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
            <label for="student_${student.id}" class="ml-2 text-sm text-gray-700">${student.name}</label>
        </div>`;
            });


            div_data += `
                    </div>
                </div>
                <div class='flex justify-end'>
                    <button id='save_attendance' class='btn btn-success' type='button'>Save Attendance Data</button>
                </div>`;
            $("#student_data").html(div_data);
        }

        $(document).on("click", "#save_attendance", function () {
            $(this).attr("disabled", "disabled").text("Saving Attendance Data...");

            const student_data = $("input[name='student_data[]']").map(function () {
                return {
                    id: $(this).val(),
                    status: $(this).is(":checked") ? 1 : 0
                };
            }).get();

            const attendance_date = $("#attendance_date").val();
            const subject_id = $("#subject").val();
            const session_year_id = $("#session_year").val();
            const dataToSend = {
                student_ids: JSON.stringify(student_data),
                attendance_date: attendance_date,
                subject_id: subject_id,
                session_year_id: session_year_id
            };

            $.ajax({
                url: '{% url 'save_attendance_data' %}',
                type: 'POST',
                data: dataToSend,
                success: function (response) {
                    if (response === "OK") {
                        alert("Attendance Saved!");
                    } else {
                        alert("Failed to Save Attendance!");
                    }
                    location.reload();
                },
                error: function () {
                    alert("Error in Saving Students Attendance Data.");
                }
            });
        });
    });
</script>
{% endblock custom_js %}